<!-- Licensed under the GPLv3 Licence. -->

<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <!-- Metadados -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenLibraryHub (0.0.4)</title>

    <!-- CSS -->
    <style>
        * {
            font-family: 'Segoe UI Variable Display', 'Segoe UI', Helvetica, sans-serif;
        }
        
        body {
            background-color: #111111;
            color: #ffffff;
        }
    </style>
</head>

<body>
     <!-- Divs -->
     <div id="header"></div>
     <div id="content"></div>
     <div id="footer"></div>

    <!-- JavaScript -->
    <script>
        // Global variables ---------------------------------------------
        const divHeader = document.getElementById("header");
        const divContent = document.getElementById("content");
        const divFooter = document.getElementById("footer");
        const version = "0.0.4";

        // Pages --------------------------------------------------------
        const openMainPage = () => {
            divHeader.innerHTML = `
                <h1>OpenLibraryHub</h1>
                <h3>Obs: essa é uma versão experimental</h3>
                <hr>

                <div id="form1">
                    <label>Adicionar livro pelo nome:</label>
                    <input type="text" id="bookName1">
                    <button onclick="runForm1()">Adicionar</button>
                </div>
                <br>

                <div id="form2">
                    <label>Verificar se o livro está cadastro pelo id:</label>
                    <input type="text" id="bookId">
                    <button onclick="runForm2()">Buscar</button>
                </div>
                <br>

                <div id="form3">
                    <label>Adicionar estudante:</label>
                    <input type="text" id="studentName">
                    <button onclick="runForm3()">Adicionar</button>
                </div>
                <br>

                <div id="form4">
                    <label>Verificar se o estudante está cadastrado pelo id:</label>
                    <input type="text" id="studentId">
                    <button onclick="runForm4()">Buscar</button>
                </div>
                <br>

                <div id="form5">
                    <label>Adicionar turma:</label>
                    <input type="text" id="className">
                    <button onclick="runForm5()">Adicionar</button>
                </div>
                <br>

                <div id="form6">
                    <label>Verificar se a turma está cadastrada pelo id:</label>
                    <input type="text" id="classId">
                    <button onclick="runForm6()">Buscar</button>
                </div>
                <br>

                <div id="form7">
                    <label>Emprestar livro de id:</label>
                    <input type="text" id="bookId2">
                    <label>para o estudante de id:</label>
                    <input type="text" id="studentId2">
                    <button onclick="runForm7()">Emprestar</button>
                </div>
                <hr>

                <button onclick="deleteLocalStorage()">Resetar tudo</button>
                <button onclick="makeBackupLocalStorage()">Fazer backup dos dados</button>
                <hr>

                <h2>Lista de livros:</h2>
                <ul id="bookList"></ul>

                <h2>Lista de estudantes:</h2>
                <ul id="studentList"></ul>

                <h2>Lista de turmas:</h2>
                <ul id="classList"></ul>
                <br>
            `;
            
            showBookList();
            showStudentList();
            showClassList();
        }

        // Classes ------------------------------------------------------
        class Book {
            constructor(id, name, author, pages, year) {
                this.id = id;
                this.name = name;
                this.author = author;
                this.pages = pages;
                this.year = year;
            }
        }

        class Student {
            constructor(id, name, currentClass) {
                this.id = id;
                this.name = name;
                this.schoolClass = currentClass;
            }
        }

        class Class {
            constructor(id, name) {
                this.id = id;
                this.name = name;
            }
        }

        // localStorage -------------------------------------------------
        const saveBook = (id, name, author, pages, year) => {
            console.log(`localStorage: salvando livro "${name}"...`);
            const book = new Book(id, name, author, pages, year);
            book.type = "Book";
            localStorage.setItem(localStorage.length++, JSON.stringify(book));
            console.log(`localStorage: livro "${name}" salvo com sucesso!`);
        }

        const getAllBooks = () => {
            const books = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const book = localStorage.getItem(key);
                if (JSON.parse(book).type == "Book") {
                    books.push(book);
                }
            }
            return books;
        }

        const getBookById = (id) => {
            console.log(`localStorage: procurando livro com id "${id}"...`);
            const books = getAllBooks();

            if (books.length == 0) {
                return console.error("localStorage: nenhum livro encontrado...");
            }
            
            for (let i = 0; i < localStorage.length; i++) {
                if (books[i] == null) {
                    continue;
                }
                const book = JSON.parse(books[i]);
                if (book.id == id) {
                    return book;
                }
            }

            return console.error(`localStorage: livro com id "${id}" não encontrado...`);
        }

        const getBookByLocalStorageKey = (key) => {
            console.log(`localStorage: procurando livro com chave "${key}"...`);
            const book = localStorage.getItem(key);
            if (JSON.parse(book).type == "Book") {
                return book;
            } else {
                return console.error(`localStorage: livro com chave "${key}" não encontrado...`);
            }
        }

        const showBookList = () => {
            const bookList = document.getElementById("bookList");
            const books = getAllBooks();

            bookList.innerHTML = "";
            books.forEach((book) => {
                const li = document.createElement("li");
                li.textContent = book;
                bookList.appendChild(li);
            });
        }

        const removeBookById = (id) => {
            console.log(`localStorage: removendo livro com id "${id}"...`);
            const book = getBookById(id);
            if (book) {
                localStorage.removeItem(id);
                showBookList();
                console.log(`localStorage: livro removido com sucesso!`);
            }
        }

        const addStudent = (id, name, currentClass) => {
            console.log(`localStorage: salvando estudante "${name}"...`);
            const student = new Student(id, name, currentClass);
            student.type = "Student";
            localStorage.setItem(localStorage.length++, JSON.stringify(student));
            console.log(`localStorage: estudante "${name}" salvo com sucesso!`);
        }

        const getAllStudents = () => {
            const students = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const student = localStorage.getItem(key);
                if (JSON.parse(student).type == "Student") {
                    students.push(student);
                }
            }
            return students;
        }

        const getStudentById = (id) => {
            console.log(`localStorage: procurando estudante com id "${id}"...`);
            const students = getAllStudents();

            if (students.length == 0) {
                return console.error("localStorage: nenhum estudante encontrado...");
            }

            for (let i = 0; i < localStorage.length; i++) {
                if (students[i] == null) {
                    continue;
                }
                const student = JSON.parse(students[i]);
                if (student.id == id) {
                    return student;
                }
            }

            return console.error(`localStorage: estudante com id "${id}" não encontrado...`);
        }

        const getStudentByLocalStorageKey = (key) => {
            console.log(`localStorage: procurando estudante com chave "${key}"...`);
            const student = localStorage.getItem(key);
            if (JSON.parse(student).type == "Student") {
                return student;
            } else {
                return console.error(`localStorage: estudante com chave "${key}" não encontrado...`);
            }
        }

        const showStudentList = () => {
            const studentList = document.getElementById("studentList");
            const students = getAllStudents();

            studentList.innerHTML = "";
            students.forEach((student) => {
                const li = document.createElement("li");
                li.textContent = student;
                studentList.appendChild(li);
            });
        }

        const removeStudentById = (id) => {
            console.log(`localStorage: removendo estudante com id "${id}"...`);
            const student = getStudentById(id);
            if (student) {
                localStorage.removeItem(id);
                showStudentList();
                console.log(`localStorage: estudante removido com sucesso!`);
            }
        }

        const addClass = (id, name) => {
            console.log(`localStorage: salvando turma "${name}""...`);
            const schoolClass = new Class(id, name);
            schoolClass.type = "Class";
            localStorage.setItem(localStorage.length++, JSON.stringify(schoolClass));
            console.log("localStorage: turma '" + name + "' salva com sucesso!");
        }

        const getAllClasses = () => {
            const classes = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const schoolClass = localStorage.getItem(key);
                if (JSON.parse(schoolClass).type == "Class") {
                    classes.push(schoolClass);
                }
            }
            return classes;
        }

        const getClassById = (id) => {
            console.log(`localStorage: procurando turma com id "${id}"...`);
            const classes = getAllClasses();

            if (classes.length == 0) {
                return console.error("localStorage: nenhuma turma encontrada...");
            }

            for (let i = 0; i < localStorage.length; i++) {
                if (classes[i] == null) {
                    continue;
                }
                const schoolClass = JSON.parse(classes[i]);
                if (schoolClass.id == id) {
                    return schoolClass;
                }
            }

            return console.error(`localStorage: turma com id "${id}" não encontrada...`);
        }

        const getClassByLocalStorageKey = (key) => {
            console.log(`localStorage: procurando turma com chave "${key}"...`);
            const schoolClass = localStorage.getItem(key);
            if (JSON.parse(schoolClass).type == "Class") {
                return schoolClass;
            } else {
                return console.error(`localStorage: turma com chave "${key}" não encontrada...`);
            }
        }

        const showClassList = () => {
            const classList = document.getElementById("classList");
            const classes = getAllClasses();

            classList.innerHTML = "";
            classes.forEach((schoolClass) => {
                const li = document.createElement("li");
                li.textContent = schoolClass;
                classList.appendChild(li);
            });
        }

        const removeClassById = (id) => {
            console.log(`localStorage: removendo turma com id "${id}"...`);
            const schoolClass = getClassById(id);
            if (schoolClass) {
                localStorage.removeItem(id);
                showClassList();
                console.log(`localStorage: turma removida com sucesso!`);
            }
        }

        const lendBook = (bookId, studentId) => {
            console.log(`localStorage: emprestando livro "${bookId}" para o estudante "${studentId}"...`);
            const book = getBookById(bookId);
            const student = getStudentById(studentId);
            book.lent = true;
            book.lentTo = studentId;
            student.lentBook = bookId;
            localStorage.setItem(bookId, JSON.stringify(book));
            localStorage.setItem(studentId, JSON.stringify(student));
            console.log(`localStorage: livro "${bookId}" emprestado para o estudante "${studentId}" com sucesso!`);
        }

        const deleteLocalStorage = () => {
            console.log("localStorage: apagando todos os dados...");
            localStorage.clear();
            showBookList();
            showStudentList();
            showClassList();
            console.log("localStorage: os dados foram apagados com sucesso!");
        }

        // IndexedDB ----------------------------------------------------
        // TODO

        // Forms --------------------------------------------------------
        const runForm1 = () => {
            const bookName = document.getElementById("bookName1");

            if (bookName.value) {
                saveBook(localStorage.length++, bookName.value);
                bookName.value = "";
                showBookList();
                return false;
            } else {
                alert("Por favor, insira o nome do livro.");
                return false;
            }
        }

        const runForm2 = () => {
            const bookName = document.getElementById("bookId");

            if (bookName.value) {
                if (getBookById(bookName.value)) {
                    alert(`O livro com id "${bookName.value}" está cadastrado.`);
                } else {
                    alert(`O livro com id "${bookName.value}" não está cadastrado.`);
                }
            } else {
                alert("Por favor, insira o id do livro.");
                return false;
            }
        }

        const runForm3 = () => {
            const studentName = document.getElementById("studentName");

            if (studentName.value) {
                addStudent(localStorage.length++, studentName.value);
                studentName.value = "";
                showStudentList();
                return false;
            } else {
                alert("Por favor, insira o nome do estudante.");
                return false;
            }
        }

        const runForm4 = () => {
            const studentId = document.getElementById("studentId");

            if (studentId.value) {
                if (getStudentById(studentId.value)) {
                    alert(`O estudante com id "${studentId.value}" está cadastrado.`);
                } else {
                    alert(`O estudante com id "${studentId.value}" não está cadastrado.`);
                }
            } else {
                alert("Por favor, insira o id do estudante.");
                return false;
            }
        }

        const runForm5 = () => {
            const className = document.getElementById("className");

            if (className.value) {
                addClass(localStorage.length++, className.value);
                className.value = "";
                showClassList();
                return false;
            } else {
                alert("Por favor, insira o nome da turma.");
                return false;
            }
        }

        const runForm6 = () => {
            const classId = document.getElementById("classId");

            if (classId.value) {
                if (getClassById(classId.value)) {
                    alert(`A turma com id "${classId.value}" está cadastrada.`);
                } else {
                    alert(`A turma com id "${classId.value}" não está cadastrada.`);
                }
            } else {
                alert("Por favor, insira o id da turma.");
                return false;
            }
        }

        const runForm7 = () => {
            const bookId = document.getElementById("bookId2");
            const studentId = document.getElementById("studentId2");

            if (bookId.value && studentId.value) {
                if (getBookById(bookId.value) && getStudentById(studentId.value)) {
                    lendBook(bookId.value, studentId.value);
                    bookId.value = "";
                    studentId.value = "";
                    showBookList();
                    showStudentList();
                    return false;
                } else {
                    alert("O livro ou o estudante não está cadastrado.");
                    return false;
                }
            } else {
                alert("Por favor, insira o id do livro e do estudante.");
                return false;
            }
        }

        // Others -------------------------------------------------------
        const checkUpdate = () => {
            console.log("Verificando atualizações...");

            // TODO: fix this
            fetch("https://raw.githubusercontent.com/1ukidev/OpenLibraryHub/main/VERSION")
                .then((response) => {
                    return response.text();
                })
                .then((data) => {
                    console.log(`Versão atual: ${version}`);
                    console.log(`Retorno: ${data}`);

                    if (data == version) {
                        alert("Você está usando a versão mais recente!");
                        console.log("Você está usando a versão mais recente!");
                    } else {
                        alert("Há uma atualização disponível! Acesse 'https://github.com/1ukidev/OpenLibraryHub' para baixar a nova versão.");
                        console.log("Há uma atualização disponível! Acesse 'https://github.com/1ukidev/OpenLibraryHub' para baixar a nova versão.");
                    }
                })
                .catch((error) => {
                    return console.error(`Erro ao verificar atualizações: ${error}`);
                });
        }

        const makeBackupLocalStorage = () => {
            console.log("Fazendo backup...");
            let values;
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                values += localStorage.getItem(key);
            }
            if (values == undefined) {
                alert("Erro ao fazer backup: nenhum dado encontrado.");
                return console.error("Erro ao fazer backup: nenhum dado encontrado.");
            }
            const valuesBase64 = btoa(values.replace("undefined", ""));

            const link = document.createElement("a");
            link.href = `data:text/plain;base64,${valuesBase64}`;
            link.download = "OpenLibraryHubBackup.txt";
            link.click();

            console.log("Backup feito com sucesso!");
        }

        // Initialization -----------------------------------------------
        document.body.onload = () => {
            console.log(`Inicializando OpenLibraryHub (${version})...`);
            openMainPage();
            console.log("Inicializado com sucesso!");
        }
    </script>
</body>

</html>
